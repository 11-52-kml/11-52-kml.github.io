<thead>
  <tr>
    <th>Grad</th>
    <th>Kontakt</th>
    <th>Status</th>
  </tr>
</thead>

<script>
  // Ako je sajt user/org Pages: ostavi apsolutnu putanju
  // Ako je project Pages (/repo/), koristi relativnu (npr. "data/public_slots.json")
  const URL = '/data/public_slots.json';

  // Ključevi iz različitih varijanti zaglavlja
  const KEY_CITY = [
    'Grad',
    'Grad (za dijasporu, navesti i državu)'
  ];
  const KEY_CONTACT = [
    'Bezbedan kontakt (Telegram grupa/Viber community, ili stranica ili grupa zbora/organizacije)',
    'Kontakt',
    'Kontakt grupa'
  ];
  const KEY_STATUS = ['Status'];

  // Učitavanje i render
  fetch(URL, { cache: 'no-store' })
    .then(r => {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    })
    .then(rows => {
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';
      if (!Array.isArray(rows) || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Trenutno nema prijavljenih lokacija.</td></tr>';
        return;
      }

      // Normalizacija i (po želji) sortiranje po Gradu
      const norm = rows.map(r => ({
        grad: pick(r, KEY_CITY),
        kontakt: pick(r, KEY_CONTACT),
        status: pick(r, KEY_STATUS)
      })).filter(x => x.grad);

      norm.sort((a, b) => a.grad.localeCompare(b.grad, 'sr', { sensitivity: 'base' }));

      for (const {grad, kontakt, status} of norm) {
        const tr = document.createElement('tr');

        const href = toAbsoluteLink(kontakt);
        const kontaktHtml = href
          ? `<a href="${escapeAttr(href)}" target="_blank" rel="noopener noreferrer nofollow">Pridruži se</a>`
          : (kontakt ? escapeHtml(kontakt) : '');

        tr.innerHTML = `
          <td><b>${escapeHtml(grad)}</b></td>
          <td>${kontaktHtml}</td>
          <td>${escapeHtml(status)}</td>
        `;
        tbody.appendChild(tr);
      }
    })
    .catch(err => {
      console.error(err);
      document.querySelector('#tbl tbody').innerHTML =
        `<tr><td colspan="3" style="text-align:center;">Greška pri učitavanju podataka. Otvorite <a href="${URL}">${URL}</a> direktno.</td></tr>`;
    });

  // --- Helpers ---
  function pick(row, keys){
    for (const k of keys) {
      if (Object.prototype.hasOwnProperty.call(row, k)) {
        const v = String(row[k] ?? '').trim();
        if (v) return v;
      }
    }
    return '';
  }
  function toAbsoluteLink(s){
    if (!s) return '';
    let v = String(s).trim();

    // Telegram: dozvoli t.me/ i telegram.me/ bez šeme -> dodaj https://
    if (/^(t\.me\/|telegram\.me\/)/i.test(v)) v = 'https://' + v;

    // Protocol-relative -> https
    if (/^\/\//.test(v)) v = 'https:' + v;

    // Dozvoli samo http(s)
    if (!/^https?:\/\//i.test(v)) return '';
    return v;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }
</script>
